<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>

    .map-overlay {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        position: absolute;
        width: 25%;
        top: 0;
        left: 0;
        padding: 10px;
    }

    .map-overlay .map-overlay-inner {
        background-color: #fff;
        box-shadow:0 1px 2px rgba(0, 0, 0, 0.20);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .map-overlay h2 {
        line-height: 24px;
        display: block;
        margin: 0 0 10px;
    }

    .map-overlay .legend .bar {
        height: 10px;
        display: inline-block;
    }

    .map-overlay input {
        background-color: transparent;
        display: inline-block;
        width: 100%;
        position: relative;
        margin: 0;
        cursor: ew-resize;
    }

    #fly {
            display: block;
            position: relative;
            margin: 0px auto;
            width: 5%;
            height: 40px;
            padding: 10px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
            color: #fff;
            background: #ee8a65;
        }
    #reset {
            display: block;
            position: relative;
            margin: 0px auto;
            width: 5%;
            height: 40px;
            padding: 10px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
            color: #fff;
            background: #ee8a65;
        }
</style>

<style type='text/css'>
    #info {
        display: block;
        position: relative;
        margin: 0px auto;
        width: 50%;
        padding: 10px;
        border: none;
        border-radius: 3px;
        font-size: 12px;
        text-align: center;
        color: #222;
        background: #fff;
    }
</style>

<div id='map'></div>
<pre id='info'></pre>
<br/>
<button id='reset'>Reset</button>
<br/>
<button id='fly'>NW Uganda</button>

<div class='map-overlay top'>
    <div class='map-overlay-inner'>
        <fieldset>
          <label>Select Data Source: </label>
          <select id='data_picker' name='data_picker'>
              <option value='cbsd_anyDisease_2'>CBSD</option>
              <option value='cmd_anyDisease_2'>CMD</option>
              <option value='whitefly_mean'>Whitefly</option>
          </select>
        </fieldset>
    </div>
    <div class='map-overlay-inner'>
      <label id='year_slider_label'></label>
      <input id='year_slider' type='range' min='0' max='2' step='1' value='0' />
      <select id='data_picker_cumInst' name='data_picker_cumInst'>
          <option value='cumulative'>Cumulative</option>
          <option value='instantaneous'>Instantaneous</option>
      </select>
      <select id='data_picker_AnyCultivar' name='data_picker_AnyCultivar'>
          <option value='dominantCultivar'>Dominant Cultivar</option>
          <option value='anyCultivar'>Any Cultivar</option>
      </select>
    </div>
    <div class='map-overlay-inner'>
      <div>Disease Severity</div>
        <div id='CBSD_legend' class='legend'>
        </div>
        <div id='CBSD_legend_text' class="legend">
        </div>
    </div>
    <div class='map-overlay-inner'>
      <div>Whitefly Count</div>
        <div id='whitefly_legend' class='legend'>
        </div>
        <div id='whitefly_legend_text' class="legend">
        </div>
    </div>
</div>


<nav id="menu"></nav>

<script>

var startingLoc = [32.6,1.35];
var startingZoom = 6;

mapboxgl.accessToken = 'pk.eyJ1IjoiZHNnMzgiLCJhIjoiY2lwaXNiOXlsMDA1NXZta3dxMDV3azQwYSJ9.XdVMSS9UIGCybRDzbsDMDQ';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v9',
    zoom: startingZoom,
    center: startingLoc
});

var layerId = 'FINAL_allCassavaSurveyDataSummar'
var tileLink = 'mapbox://dsg38.cj5drv9n70ilb32kz5smjeakd-147h9'
var cbsd_binary_column = 'cbsd_anyDisease_2'

var cmd_binary_column = 'cmd_anyDisease_2'
var missingStr = 'MIZ'

var CBSD_legend = document.getElementById('CBSD_legend');
var CBSD_legend_text = document.getElementById('CBSD_legend_text');
var whitefly_legend = document.getElementById('whitefly_legend');
var whitefly_legend_text = document.getElementById('whitefly_legend_text');
var yearLabel = document.getElementById('year_slider_label');
var yearSlider = document.getElementById('year_slider');
var cumInstPicker = document.getElementById('data_picker_cumInst');
var anyCultivarPicker = document.getElementById('data_picker_AnyCultivar');
var pickData = document.getElementById('data_picker');


var years = [ '2004.0', '2005.0', '2006.0', '2007.0', '2008.0', '2009.0', '2010.0', '2011.0', '2012.0', '2013.0', '2014.0', '2015.0' ]

yearSlider.max = years.length - 1;

yearDataCumulative = "<="
yearDataInstantaneous = "=="
cumulativeOrInstantaneous = yearDataCumulative


var CBSD_colours = [
    [-9999, '#d9d9d9'],
    [0, '#2D6200'],
    [0, '#2D6200'],
    [0.0001, '#FFC300'],
    [0.1, '#FFC300'],
    [0.10001, '#FF5733'],
    [0.5, '#FF5733'],
    [0.50001, '#C70039'],
    [1, '#C70039']
  ];


var true_false_colours = [
    ['0.0', '#2D6200'],
    ['1.0', '#C70039'],
    [missingStr, '#1C37E6']
  ];

var whitefly_colours = [
    [0, '#2D6200'],
    [0, '#2D6200'],
    [0.00001, '#FFC300'],
    [5, '#FFC300'],
    [5.00001, '#FA8808'],
    [10, '#FA8808'],
    [10.0001, '#FA5808'],
    [15, '#FA5808'],
    [15.0001, '#FA0808'],
    [20, '#FA0808'],
    [20.0001, '#FA08A2'],
    [100, '#FA08A2'],
    [100.0001, '#9E08FA'],
    [200, '#9E08FA']
  ];

pickData.addEventListener('click', function() {

  var theseColours = true_false_colours;
  if (pickData.value == "whitefly_mean") {
    var theseColours = whitefly_colours;
  }

  map.setPaintProperty(layerId, 'circle-color', {
      property: pickData.value,
      stops: theseColours
  });
});

cumInstPicker.addEventListener('click', function() {

  if(cumInstPicker.value == "cumulative") {
    cumulativeOrInstantaneous = yearDataCumulative
  }
  if(cumInstPicker.value == "instantaneous") {
    cumulativeOrInstantaneous = yearDataInstantaneous
  }

  var yearIndex = parseInt(document.getElementById('year_slider').value, 10);

  filterBy(yearIndex)

});

anyCultivarPicker.addEventListener('click', function() {

  if(anyCultivarPicker.value == "dominantCultivar") {
    var cbsd_binary_column = 'cbsd_anyDisease_2'
  }
  if(anyCultivarPicker.value == "anyCultivar") {
    var cbsd_binary_column = 'cbsd_in_any_cultivar'
  }

  map.setPaintProperty(layerId, 'circle-color', {
      property: cbsd_binary_column,
      stops: true_false_colours
  });

});


function filterBy(yearIndex) {

    var year = years[yearIndex];
    yearLabel.textContent = parseInt(year);

    var filters = [cumulativeOrInstantaneous, "year", year];

    map.setFilter(layerId, filters);
}

map.on('load', function () {

  map.addSource(layerId, {
      type: 'vector',
      url: tileLink
  });
  map.addLayer({
      'id': layerId,
      'type': 'circle',
      'source': layerId,
      'source-layer': layerId,
      'paint': {
          // color circles by value, using data-driven styles
          'circle-color': {
              property: cbsd_binary_column,
              stops: true_false_colours
          }
      }
  });

  // Add legend bar
  for(var iCol = CBSD_colours.length - 1; iCol >= 1; iCol--) {
    var bar = document.createElement('div');
    bar.className = 'bar';
    bar.title = CBSD_colours[iCol][0];
    bar.style.width = 100.0 / (CBSD_colours.length - 1) + '%';
    bar.style.backgroundColor = CBSD_colours[iCol][1];
    CBSD_legend.insertBefore(bar, CBSD_legend.firstChild);
  }

  for(var iCol = CBSD_colours.length - 1; iCol > 0; iCol -= 2) {
    var spacebar = document.createElement('div');
    spacebar.className = 'bar';
    spacebar.style.width = 50.0 / CBSD_colours.length + '%';
    CBSD_legend_text.insertBefore(spacebar, CBSD_legend_text.firstChild);

    var bar = document.createElement('div');
    bar.className = 'bar';
    bar.title = CBSD_colours[iCol][0];
    bar.style.width = 100.0 / CBSD_colours.length + '%';
    bar.textContent = Math.round(CBSD_colours[iCol - 1][0]) + " - " + CBSD_colours[iCol][0];
    CBSD_legend_text.insertBefore(bar, CBSD_legend_text.firstChild);

    var spacebar = document.createElement('div');
    spacebar.className = 'bar';
    spacebar.style.width = 50.0 / CBSD_colours.length + '%';
    CBSD_legend_text.insertBefore(spacebar, CBSD_legend_text.firstChild);
  }

  // Add legend bar
  for(var iCol = whitefly_colours.length - 1; iCol >= 0; iCol--) {
    var bar = document.createElement('div');
    bar.className = 'bar';
    bar.title = whitefly_colours[iCol][0];
    bar.style.width = 100.0 / whitefly_colours.length + '%';
    bar.style.backgroundColor = whitefly_colours[iCol][1];
    whitefly_legend.insertBefore(bar, whitefly_legend.firstChild);
  }

  for(var iCol = whitefly_colours.length - 1; iCol > 0; iCol -= 2) {
    var spacebar = document.createElement('div');
    spacebar.className = 'bar';
    spacebar.style.width = 50.0 / whitefly_colours.length + '%';
    //whitefly_legend_text.insertBefore(spacebar, whitefly_legend_text.firstChild);

    var bar = document.createElement('div');
    bar.className = 'bar';
    bar.title = whitefly_colours[iCol][0];
    bar.style.width = 200.0 / whitefly_colours.length + '%';
    bar.textContent = Math.round(whitefly_colours[iCol - 1][0]) + " - " + whitefly_colours[iCol][0];
    whitefly_legend_text.insertBefore(bar, whitefly_legend_text.firstChild);

    var spacebar = document.createElement('div');
    spacebar.className = 'bar';
    spacebar.style.width = 50.0 / whitefly_colours.length + '%';
    //whitefly_legend_text.insertBefore(spacebar, whitefly_legend_text.firstChild);
  }

  filterBy(0);

  document.getElementById('year_slider').addEventListener('input', function(e) {
      var yearIndex = parseInt(e.target.value, 10);

      filterBy(yearIndex)

  });

});

map.on('click', function (e) {
    var features = map.queryRenderedFeatures(e.point, { layers: [ layerId ] });
    if (!features.length) {
        return;
    }

    var feature = features[0];

    if (!feature.properties[cbsd_binary_column]) {
      var thisCBSDsev = '-9999'
    } else {
      var thisCBSDsev = feature.properties[cbsd_binary_column]
    }

    // if (!feature.properties.CBSD_Inc) {
    //   var thisCBSDinc = '0'
    // } else {
    //   var thisCBSDinc = feature.properties.CBSD_Inc
    // }

    var popup = new mapboxgl.Popup()
        .setLngLat(map.unproject(e.point))
        // .setContent()
        .setHTML('<p>form_id: ' + feature.properties["form_id"] + '</p> <p>date: ' + feature.properties["date"] + '</p>')
        .addTo(map);

});

map.on('mousemove', function (e) {
    document.getElementById('info').innerHTML =
        // e.point is the x, y coordinates of the mousemove event relative
        // to the top-left corner of the map
        JSON.stringify(e.point) + '<br />' +
            // e.lngLat is the longitude, latitude geographical position of the event
        JSON.stringify(e.lngLat);
});

document.getElementById('fly').addEventListener('click', function () {
    // Fly to a random location by offsetting the point -74.50, 40
    // by up to 5 degrees.
    map.flyTo({
        center: [31.5, 3.0],
        zoom: 8
    });
});

document.getElementById('reset').addEventListener('click', function () {
    // Fly to a random location by offsetting the point -74.50, 40
    // by up to 5 degrees.
    map.flyTo({
        center: startingLoc,
        zoom: startingZoom
    });
});


</script>

</body>
</html>
